<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>å ±å‘Šæ›¸ä½œæˆã‚¢ãƒ—ãƒª</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root {
    --yellow: #FFFF99;
    --yellow-dark: #e6e600;
    --header-bg: #1a3a5c;
    --header-text: #ffffff;
    --accent: #2563eb;
    --accent-light: #dbeafe;
    --border: #94a3b8;
    --label-bg: #f1f5f9;
    --section-header: #1e40af;
    --section-header-light: #eff6ff;
    --danger: #dc2626;
    --success: #16a34a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Meiryo', 'Yu Gothic', sans-serif;
    background: #f0f4f8;
    min-height: 100vh;
  }

  /* ===== ã‚¢ãƒ—ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
  .app-header {
    background: var(--header-bg);
    color: white;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .app-header h1 { font-size: 17px; font-weight: bold; }
  .app-header .company-name { font-size: 11px; opacity: 0.8; margin-top: 2px; }

  /* ===== ç¨®åˆ¥é¸æŠã‚¿ãƒ– ===== */
  .type-tabs {
    display: flex;
    background: white;
    border-bottom: 2px solid var(--accent);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .type-tab {
    flex: 1;
    min-width: 90px;
    padding: 12px 6px;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    background: none;
    color: #64748b;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .type-tab.active {
    color: var(--accent);
    border-bottom: 3px solid var(--accent);
    background: var(--accent-light);
  }
  .type-tab .tab-icon { font-size: 18px; display: block; margin-bottom: 3px; }

  /* ===== ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ ===== */
  .form-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 16px;
  }

  /* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .section {
    background: white;
    border-radius: 10px;
    margin-bottom: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  .section-header {
    background: var(--section-header);
    color: white;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-body { padding: 14px; }

  /* ===== ãƒ•ã‚©ãƒ¼ãƒ è¡Œ ===== */
  .form-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: flex-start;
    flex-wrap: wrap;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 140px;
  }
  .form-group.full { flex: 100%; min-width: 100%; }
  .form-group label {
    font-size: 11px;
    font-weight: bold;
    color: #475569;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .form-group label .required {
    color: var(--danger);
    font-size: 10px;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    background: var(--yellow);
    border: 1.5px solid #ccc;
    border-radius: 5px;
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    width: 100%;
    transition: border-color 0.2s;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
  }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .form-group .static-field {
    background: var(--label-bg);
    border: 1.5px solid #e2e8f0;
    border-radius: 5px;
    padding: 8px 10px;
    font-size: 13px;
    font-weight: bold;
    color: #1e293b;
  }

  /* ===== ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— ===== */
  .radio-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    padding: 8px 0;
  }
  .radio-group label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
    font-weight: normal !important;
    color: #334155 !important;
    cursor: pointer;
  }
  .radio-group input[type="radio"] {
    width: auto;
    background: none;
    border: none;
    padding: 0;
  }

  /* ===== è¢«å®³å“ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
  .damage-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .damage-table th {
    background: var(--section-header);
    color: white;
    padding: 8px 6px;
    text-align: center;
    font-size: 11px;
    border: 1px solid #1e3a8a;
  }
  .damage-table td {
    border: 1px solid #cbd5e1;
    padding: 4px;
  }
  .damage-table td input {
    background: var(--yellow);
    border: none;
    padding: 5px;
    width: 100%;
    font-size: 12px;
    border-radius: 3px;
  }
  .damage-table td input:focus {
    outline: 1px solid var(--accent);
  }
  .add-row-btn {
    margin-top: 8px;
    padding: 6px 12px;
    background: var(--accent-light);
    color: var(--accent);
    border: 1.5px solid var(--accent);
    border-radius: 5px;
    font-size: 12px;
    cursor: pointer;
    font-weight: bold;
  }

  /* ===== å†™çœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .photo-area {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 8px;
    margin-bottom: 12px;
  }
  .photo-thumb {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e2e8f0;
  }
  .photo-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .photo-thumb .delete-photo {
    position: absolute;
    top: 3px;
    right: 3px;
    background: rgba(220,38,38,0.85);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  .photo-add-btn {
    aspect-ratio: 1;
    border: 2.5px dashed var(--accent);
    border-radius: 8px;
    background: var(--accent-light);
    color: var(--accent);
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .photo-add-btn:hover { background: #bfdbfe; }
  .photo-add-btn.disabled {
    border-color: #cbd5e1;
    background: #f8fafc;
    color: #94a3b8;
    cursor: not-allowed;
  }
  .photo-count {
    font-size: 12px;
    color: #64748b;
    margin-bottom: 8px;
  }
  .camera-input { display: none; }

  /* ===== ç¨®åˆ¥å›ºæœ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .type-section { display: none; }
  .type-section.show { display: block; }

  /* ===== ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ ===== */
  .btn-area {
    padding: 16px;
    background: white;
    border-top: 1px solid #e2e8f0;
    position: sticky;
    bottom: 0;
    display: flex;
    gap: 10px;
  }
  .btn-pdf {
    flex: 2;
    padding: 14px;
    background: var(--header-bg);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn-pdf:hover { background: #0f2744; }
  .btn-reset {
    flex: 1;
    padding: 14px;
    background: white;
    color: var(--danger);
    border: 2px solid var(--danger);
    border-radius: 8px;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
  }
  .btn-reset:hover { background: #fee2e2; }

  /* ===== PDFç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆéè¡¨ç¤ºï¼‰ ===== */
  #pdf-template {
    position: absolute;
    left: -9999px;
    top: 0;
    width: 794px;
    background: white;
    padding: 30px 35px;
    font-family: 'Meiryo', 'Yu Gothic', 'MS Gothic', sans-serif;
    font-size: 11pt;
    color: #000;
  }
  .pdf-company {
    font-size: 13pt;
    font-weight: bold;
    margin-bottom: 6px;
  }
  .pdf-meta-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .pdf-meta-row span { font-size: 11pt; }
  .pdf-title-row {
    display: flex;
    align-items: center;
    margin: 10px 0 14px;
    border: 2px solid #000;
    padding: 8px 12px;
  }
  .pdf-title-label { font-size: 13pt; font-weight: bold; margin-right: 20px; }
  .pdf-title-value { font-size: 16pt; font-weight: bold; }
  .pdf-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  .pdf-table th, .pdf-table td {
    border: 1.5px solid #000;
    padding: 6px 10px;
    font-size: 10.5pt;
    vertical-align: top;
  }
  .pdf-table .label-cell {
    background: #f0f0f0;
    font-weight: bold;
    white-space: nowrap;
    width: 120px;
  }
  .pdf-table .value-cell {
    background: var(--yellow);
    white-space: pre-wrap;
    word-break: break-all;
  }
  .pdf-section-title {
    background: #1a3a5c;
    color: white;
    font-weight: bold;
    font-size: 11pt;
    padding: 5px 10px;
    margin-top: 12px;
    margin-bottom: 0;
  }
  .pdf-damage-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0;
  }
  .pdf-damage-table th {
    background: #d0d8e8;
    border: 1.5px solid #000;
    padding: 5px 8px;
    font-size: 10pt;
    font-weight: bold;
    text-align: center;
  }
  .pdf-damage-table td {
    border: 1.5px solid #000;
    padding: 5px 8px;
    background: var(--yellow);
    font-size: 10pt;
    min-height: 22px;
  }
  .pdf-photos-section { margin-top: 14px; }
  .pdf-photos-title {
    background: #1a3a5c;
    color: white;
    font-weight: bold;
    padding: 5px 10px;
    margin-bottom: 8px;
  }
  .pdf-photos-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
  }
  .pdf-photo-item { position: relative; }
  .pdf-photo-item img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    border: 1.5px solid #000;
  }
  .pdf-photo-num {
    font-size: 9pt;
    text-align: center;
    margin-top: 2px;
  }
  .pdf-specific-section { margin-top: 12px; }

  /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
  .loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    gap: 16px;
  }
  .loading-overlay.show { display: flex; }
  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255,255,255,0.3);
    border-top: 5px solid white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
  @media (max-width: 480px) {
    .form-container { padding: 10px; }
    .form-group { min-width: 100%; }
    .photo-area { grid-template-columns: repeat(4, 1fr); }
  }
</style>
</head>
<body>

<!-- ã‚¢ãƒ—ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="app-header">
  <div>
    <div class="app-header h1" style="font-size:17px;font-weight:bold;">ğŸ“‹ å ±å‘Šæ›¸ä½œæˆã‚¢ãƒ—ãƒª</div>
    <div class="company-name" id="header-company">æ ªå¼ä¼šç¤¾ ã‚¼ãƒ­ã‚¨ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
  </div>
  <div style="font-size:11px;opacity:0.7;text-align:right;">ver 1.0</div>
</div>

<!-- ç¨®åˆ¥ã‚¿ãƒ– -->
<div class="type-tabs">
  <button class="type-tab active" onclick="switchType('accident')" id="tab-accident">
    <span class="tab-icon">âš ï¸</span>äº‹æ•…å ±å‘Šæ›¸
  </button>
  <button class="type-tab" onclick="switchType('incident')" id="tab-incident">
    <span class="tab-icon">ğŸš¨</span>äº‹ä»¶å ±å‘Šæ›¸
  </button>
  <button class="type-tab" onclick="switchType('claim')" id="tab-claim">
    <span class="tab-icon">ğŸ’¬</span>ã‚¯ãƒ¬ãƒ¼ãƒ å ±å‘Šæ›¸
  </button>
</div>

<!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ -->
<div class="form-container">

  <!-- ===== åŸºæœ¬æƒ…å ± ===== -->
  <div class="section">
    <div class="section-header">ğŸ¢ åŸºæœ¬æƒ…å ±</div>
    <div class="section-body">
      <div class="form-row">
        <div class="form-group full">
          <label>ä¼šç¤¾å</label>
          <div class="static-field" id="company-display">æ ªå¼ä¼šç¤¾ ã‚¼ãƒ­ã‚¨ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>å ±å‘Šæ—¥ <span class="required">*</span></label>
          <input type="date" id="report-date">
        </div>
        <div class="form-group full" style="flex:100%;min-width:100%;">
          <label>è¡¨é¡Œã€€<span style="font-size:10px;font-weight:normal;color:#64748b;">ï¼ˆç¨®åˆ¥ã¯è‡ªå‹• ï¼ å†…å®¹ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰</span></label>
          <div style="display:flex;align-items:center;gap:0;border:1.5px solid #ccc;border-radius:5px;overflow:hidden;background:var(--yellow);">
            <input type="text" id="title-sub" placeholder="ä¾‹ï¼šæ¬å‡ºæ™‚ã®ãŠå®¢æ§˜å®…åºŠãƒ»å£æå‚·" style="flex:1;border:none;background:var(--yellow);padding:8px 10px;font-size:13px;font-family:inherit;outline:none;">
            <div id="title-display" style="background:#e2e8f0;color:#1e3a5f;font-weight:bold;font-size:13px;padding:8px 12px;white-space:nowrap;border-left:1.5px solid #ccc;">äº‹æ•…å ±å‘Šæ›¸</div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>åº—èˆ—å <span class="required">*</span></label>
          <input type="text" id="store-name" placeholder="ä¾‹ï¼šæ¸‹è°·åº—">
        </div>
        <div class="form-group">
          <label>å ±å‘Šè€…å <span class="required">*</span></label>
          <input type="text" id="reporter-name" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>æ‰€å±ãƒ»éƒ¨ç½²</label>
          <input type="text" id="department" placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨">
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ç™ºç”Ÿæƒ…å ± ===== -->
  <div class="section">
    <div class="section-header">ğŸ• ç™ºç”Ÿæƒ…å ±</div>
    <div class="section-body">
      <div class="form-row">
        <div class="form-group">
          <label>ç™ºç”Ÿæ—¥æ™‚ <span class="required">*</span></label>
          <input type="datetime-local" id="incident-datetime">
        </div>
        <div class="form-group">
          <label>ç™ºç”Ÿå ´æ‰€ <span class="required">*</span></label>
          <input type="text" id="incident-place" placeholder="ä¾‹ï¼š1éš ãƒ¬ã‚¸ä»˜è¿‘">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>ç™ºç”ŸçŠ¶æ³ï¼ˆè©³ç´°ï¼‰ <span class="required">*</span></label>
          <textarea id="incident-detail" rows="5" placeholder="ç™ºç”Ÿã®çµŒç·¯ãƒ»çŠ¶æ³ã‚’è©³ã—ãè¨˜è¿°ã—ã¦ãã ã•ã„"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== äº‹æ•…å›ºæœ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
  <div class="type-section show" id="section-accident">
    <div class="section">
      <div class="section-header">ğŸ¥ äººçš„ãƒ»ç‰©çš„è¢«å®³</div>
      <div class="section-body">
        <div class="form-row">
          <div class="form-group">
            <label>è² å‚·è€…ã®æœ‰ç„¡</label>
            <div class="radio-group">
              <label><input type="radio" name="injured" value="ãªã—" checked> ãªã—</label>
              <label><input type="radio" name="injured" value="ã‚ã‚Š"> ã‚ã‚Š</label>
            </div>
          </div>
          <div class="form-group">
            <label>è­¦å¯Ÿã¸ã®å±Šå‡º</label>
            <div class="radio-group">
              <label><input type="radio" name="police" value="ãªã—" checked> ãªã—</label>
              <label><input type="radio" name="police" value="ã‚ã‚Š"> ã‚ã‚Š</label>
            </div>
          </div>
          <div class="form-group">
            <label>æ•‘æ€¥ã¸ã®é€£çµ¡</label>
            <div class="radio-group">
              <label><input type="radio" name="ambulance" value="ãªã—" checked> ãªã—</label>
              <label><input type="radio" name="ambulance" value="ã‚ã‚Š"> ã‚ã‚Š</label>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full">
            <label>è² å‚·è€…æƒ…å ±ï¼ˆæ°åãƒ»çŠ¶æ³ãªã©ï¼‰</label>
            <textarea id="injured-info" rows="2" placeholder="è² å‚·ãŒã‚ã‚‹å ´åˆã€æ°åãƒ»ç—‡çŠ¶ãƒ»æ¬é€å…ˆãªã©ã‚’è¨˜å…¥"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="section-header">ğŸ“¦ è¢«å®³å“</div>
      <div class="section-body">
        <div style="overflow-x:auto;">
          <table class="damage-table" id="damage-table-accident">
            <thead>
              <tr>
                <th style="width:40%">è¢«å®³å“å</th>
                <th style="width:30%">ã‚·ãƒªã‚¢ãƒ«â„–</th>
                <th style="width:20%">è¢«å®³é¡</th>
                <th style="width:10%"></th>
              </tr>
            </thead>
            <tbody id="damage-body-accident">
              <tr>
                <td><input type="text" placeholder="å“åã‚’å…¥åŠ›"></td>
                <td><input type="text" placeholder="ã‚·ãƒªã‚¢ãƒ«ç•ªå·"></td>
                <td><input type="text" placeholder="Â¥"></td>
                <td style="text-align:center;"><button onclick="removeRow(this)" style="background:none;border:none;color:#dc2626;font-size:16px;cursor:pointer;">âœ•</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <button class="add-row-btn" onclick="addRow('accident')">ï¼‹ è¡Œã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- ===== äº‹ä»¶å›ºæœ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
  <div class="type-section" id="section-incident">
    <div class="section">
      <div class="section-header">ğŸ” äº‹ä»¶è©³ç´°</div>
      <div class="section-body">
        <div class="form-row">
          <div class="form-group">
            <label>è¢«å®³ç·é¡</label>
            <input type="text" id="total-damage" placeholder="ä¾‹ï¼šÂ¥50,000">
          </div>
          <div class="form-group">
            <label>è­¦å¯Ÿå—ç†ç•ªå·</label>
            <input type="text" id="police-number" placeholder="ä¾‹ï¼šç¬¬â—‹â—‹å·">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full">
            <label>å®¹ç–‘è€…ãƒ»é–¢ä¿‚è€…æƒ…å ±ï¼ˆç‰¹å¾´ãƒ»æ°åãªã©ï¼‰</label>
            <textarea id="suspect-info" rows="3" placeholder="åˆ¤æ˜ã—ã¦ã„ã‚‹ç‰¹å¾´ãƒ»æƒ…å ±ã‚’è¨˜å…¥"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="section-header">ğŸ“¦ è¢«å®³å“</div>
      <div class="section-body">
        <div style="overflow-x:auto;">
          <table class="damage-table" id="damage-table-incident">
            <thead>
              <tr>
                <th style="width:40%">è¢«å®³å“å</th>
                <th style="width:30%">ã‚·ãƒªã‚¢ãƒ«â„–</th>
                <th style="width:20%">è¢«å®³é¡</th>
                <th style="width:10%"></th>
              </tr>
            </thead>
            <tbody id="damage-body-incident">
              <tr>
                <td><input type="text" placeholder="å“åã‚’å…¥åŠ›"></td>
                <td><input type="text" placeholder="ã‚·ãƒªã‚¢ãƒ«ç•ªå·"></td>
                <td><input type="text" placeholder="Â¥"></td>
                <td style="text-align:center;"><button onclick="removeRow(this)" style="background:none;border:none;color:#dc2626;font-size:16px;cursor:pointer;">âœ•</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <button class="add-row-btn" onclick="addRow('incident')">ï¼‹ è¡Œã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- ===== ã‚¯ãƒ¬ãƒ¼ãƒ å›ºæœ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
  <div class="type-section" id="section-claim">
    <div class="section">
      <div class="section-header">ğŸ’¬ ã‚¯ãƒ¬ãƒ¼ãƒ è©³ç´°</div>
      <div class="section-body">
        <div class="form-row">
          <div class="form-group">
            <label>ã‚¯ãƒ¬ãƒ¼ãƒ ã®ç¨®é¡</label>
            <select id="claim-type">
              <option value="æ¥å®¢æ…‹åº¦">æ¥å®¢æ…‹åº¦</option>
              <option value="å•†å“ä¸è‰¯">å•†å“ä¸è‰¯</option>
              <option value="ã‚µãƒ¼ãƒ“ã‚¹">ã‚µãƒ¼ãƒ“ã‚¹</option>
              <option value="ä¾¡æ ¼ãƒ»é‡‘éŠ­">ä¾¡æ ¼ãƒ»é‡‘éŠ­</option>
              <option value="è¡›ç”Ÿãƒ»ç’°å¢ƒ">è¡›ç”Ÿãƒ»ç’°å¢ƒ</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
          <div class="form-group">
            <label>å¯¾å¿œæ‹…å½“è€…</label>
            <input type="text" id="handler-name" placeholder="ä¾‹ï¼šéˆ´æœ¨ èŠ±å­">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>é¡§å®¢æ°å</label>
            <input type="text" id="customer-name" placeholder="ä¾‹ï¼šç”°ä¸­ ä¸€éƒï¼ˆä»»æ„ï¼‰">
          </div>
          <div class="form-group">
            <label>é¡§å®¢é€£çµ¡å…ˆ</label>
            <input type="text" id="customer-contact" placeholder="ä¾‹ï¼š090-XXXX-XXXX">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full">
            <label>å¯¾å¿œå†…å®¹</label>
            <textarea id="claim-response" rows="3" placeholder="é¡§å®¢ã¸ã®å¯¾å¿œå†…å®¹ã‚’è¨˜å…¥"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full">
            <label>å¯¾å¿œçµæœãƒ»é¡§å®¢ã®åå¿œ</label>
            <textarea id="claim-result" rows="2" placeholder="ã‚¯ãƒ¬ãƒ¼ãƒ ã®è§£æ±ºçŠ¶æ³ãƒ»é¡§å®¢ã®åå¿œã‚’è¨˜å…¥"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== åŸå› ãƒ»å¯¾ç­– ===== -->
  <div class="section">
    <div class="section-header">ğŸ” åŸå› ãƒ»å¯¾ç­–</div>
    <div class="section-body">
      <div class="form-row">
        <div class="form-group full">
          <label>ç™ºç”Ÿã®åŸå› </label>
          <textarea id="cause" rows="3" placeholder="ç™ºç”ŸåŸå› ã‚’åˆ†æã—ã¦è¨˜å…¥"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>ä»Šå¾Œã®å¯¾ç­–ãƒ»å†ç™ºé˜²æ­¢ç­–</label>
          <textarea id="countermeasure" rows="3" placeholder="å†ç™ºé˜²æ­¢ã®ãŸã‚ã®å¯¾ç­–ã‚’è¨˜å…¥"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== å‚™è€ƒ ===== -->
  <div class="section">
    <div class="section-header">ğŸ“ å‚™è€ƒ</div>
    <div class="section-body">
      <div class="form-row">
        <div class="form-group full">
          <textarea id="notes" rows="3" placeholder="ãã®ä»–ã€ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== å†™çœŸæ·»ä»˜ ===== -->
  <div class="section">
    <div class="section-header">ğŸ“· å†™çœŸæ·»ä»˜ï¼ˆæœ€å¤§10æšï¼‰</div>
    <div class="section-body">
      <div class="photo-count" id="photo-count">0 / 10 æš</div>
      <div class="photo-area" id="photo-area">
        <div class="photo-add-btn" id="photo-add-btn" onclick="triggerCamera()">ï¼‹</div>
      </div>
      <input type="file" accept="image/*" capture="environment" class="camera-input" id="camera-input" multiple onchange="handlePhotos(event)">
      <div style="font-size:11px;color:#94a3b8;margin-top:6px;">
        ğŸ“Œ ã‚«ãƒ¡ãƒ©ã§æ’®å½±ã¾ãŸã¯ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰é¸æŠã§ãã¾ã™
      </div>
    </div>
  </div>

  <div style="height: 80px;"></div>
</div>

<!-- å›ºå®šãƒœã‚¿ãƒ³ -->
<div class="btn-area">
  <button class="btn-reset" onclick="resetForm()">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="btn-pdf" onclick="generatePDF()">ğŸ“„ PDFå‡ºåŠ›</button>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div>PDFç”Ÿæˆä¸­...</div>
  <div style="font-size:12px;opacity:0.8;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
</div>

<!-- PDFç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆéè¡¨ç¤ºï¼‰ -->
<div id="pdf-template"></div>

<script>
// ===== çŠ¶æ…‹ç®¡ç† =====
let currentType = 'accident';
let photos = []; // {dataUrl, name}

const TYPE_TITLES = {
  accident: 'äº‹æ•…å ±å‘Šæ›¸',
  incident: 'äº‹ä»¶å ±å‘Šæ›¸',
  claim:    'ã‚¯ãƒ¬ãƒ¼ãƒ å ±å‘Šæ›¸'
};

// ===== åˆæœŸåŒ– =====
window.onload = () => {
  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('report-date').value = today;
};

// ===== ã‚¿ãƒ–åˆ‡æ›¿ =====
function switchType(type) {
  currentType = type;
  ['accident','incident','claim'].forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('active', t===type);
    document.getElementById('section-'+t).classList.toggle('show', t===type);
  });
  document.getElementById('title-display').textContent = TYPE_TITLES[type];
  document.getElementById('title-sub').placeholder =
    type === 'accident' ? 'ä¾‹ï¼šæ¬å‡ºæ™‚ã®ãŠå®¢æ§˜å®…åºŠãƒ»å£æå‚·' :
    type === 'incident' ? 'ä¾‹ï¼šä¸‡å¼•ããƒ»ä¸å¯©è€…ä¾µå…¥' :
    'ä¾‹ï¼šæ¥å®¢æ…‹åº¦ã«é–¢ã™ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ ';
}

// ===== è¢«å®³å“è¡Œè¿½åŠ  =====
function addRow(type) {
  const tbody = document.getElementById('damage-body-'+type);
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" placeholder="å“åã‚’å…¥åŠ›"></td>
    <td><input type="text" placeholder="ã‚·ãƒªã‚¢ãƒ«ç•ªå·"></td>
    <td><input type="text" placeholder="Â¥"></td>
    <td style="text-align:center;"><button onclick="removeRow(this)" style="background:none;border:none;color:#dc2626;font-size:16px;cursor:pointer;">âœ•</button></td>
  `;
  tbody.appendChild(tr);
}

function removeRow(btn) {
  const row = btn.closest('tr');
  const tbody = row.parentElement;
  if (tbody.rows.length > 1) row.remove();
}

// ===== å†™çœŸå‡¦ç† =====
function triggerCamera() {
  if (photos.length >= 10) return;
  document.getElementById('camera-input').click();
}

function handlePhotos(event) {
  const files = Array.from(event.target.files);
  const remaining = 10 - photos.length;
  const toAdd = files.slice(0, remaining);
  
  let loaded = 0;
  toAdd.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      photos.push({ dataUrl: e.target.result, name: `å†™çœŸ${photos.length + 1}` });
      loaded++;
      if (loaded === toAdd.length) renderPhotos();
    };
    reader.readAsDataURL(file);
  });
  event.target.value = '';
}

function renderPhotos() {
  const area = document.getElementById('photo-area');
  area.innerHTML = '';
  
  photos.forEach((photo, idx) => {
    const div = document.createElement('div');
    div.className = 'photo-thumb';
    div.innerHTML = `
      <img src="${photo.dataUrl}" alt="å†™çœŸ${idx+1}">
      <button class="delete-photo" onclick="deletePhoto(${idx})">âœ•</button>
    `;
    area.appendChild(div);
  });

  if (photos.length < 10) {
    const addBtn = document.createElement('div');
    addBtn.className = 'photo-add-btn';
    addBtn.innerHTML = 'ï¼‹';
    addBtn.onclick = triggerCamera;
    area.appendChild(addBtn);
  }

  document.getElementById('photo-count').textContent = `${photos.length} / 10 æš`;
}

function deletePhoto(idx) {
  photos.splice(idx, 1);
  photos.forEach((p, i) => p.name = `å†™çœŸ${i+1}`);
  renderPhotos();
}

// ===== è¢«å®³å“ãƒ‡ãƒ¼ã‚¿å–å¾— =====
function getDamageRows(type) {
  const tbody = document.getElementById('damage-body-'+type);
  const rows = [];
  Array.from(tbody.rows).forEach(row => {
    const inputs = row.querySelectorAll('input');
    const name = inputs[0].value.trim();
    const serial = inputs[1].value.trim();
    const amount = inputs[2].value.trim();
    if (name || serial || amount) rows.push({ name, serial, amount });
  });
  return rows;
}

// ===== ãƒ©ã‚¸ã‚ªå€¤å–å¾— =====
function getRadio(name) {
  const el = document.querySelector(`input[name="${name}"]:checked`);
  return el ? el.value : '';
}

// ===== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ =====
function validate() {
  const required = [
    { id: 'report-date', label: 'å ±å‘Šæ—¥' },
    { id: 'store-name', label: 'åº—èˆ—å' },
    { id: 'reporter-name', label: 'å ±å‘Šè€…å' },
    { id: 'incident-datetime', label: 'ç™ºç”Ÿæ—¥æ™‚' },
    { id: 'incident-place', label: 'ç™ºç”Ÿå ´æ‰€' },
    { id: 'incident-detail', label: 'ç™ºç”ŸçŠ¶æ³' },
  ];
  for (const f of required) {
    if (!document.getElementById(f.id).value.trim()) {
      alert(`ã€Œ${f.label}ã€ã¯å¿…é ˆé …ç›®ã§ã™ã€‚`);
      document.getElementById(f.id).focus();
      return false;
    }
  }
  return true;
}

// ===== ãƒªã‚»ãƒƒãƒˆ =====
function resetForm() {
  if (!confirm('å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  document.querySelectorAll('input[type="text"], input[type="datetime-local"], textarea, select').forEach(el => {
    if (el.type === 'date') return;
    el.value = '';
  });
  document.querySelectorAll('input[type="radio"]').forEach(el => {
    if (['ãªã—','ãªã—','ãªã—'].includes(el.value)) el.checked = true;
  });
  // ãƒ©ã‚¸ã‚ªã‚’ã€Œãªã—ã€ã«ãƒªã‚»ãƒƒãƒˆ
  ['injured','police','ambulance'].forEach(name => {
    const radios = document.querySelectorAll(`input[name="${name}"]`);
    radios.forEach(r => r.checked = (r.value === 'ãªã—'));
  });
  photos = [];
  renderPhotos();
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('report-date').value = today;
}

// ===== PDFç”Ÿæˆ =====
async function generatePDF() {
  if (!validate()) return;

  document.getElementById('loading').classList.add('show');
  await new Promise(r => setTimeout(r, 100));

  try {
    const company = 'æ ªå¼ä¼šç¤¾ ã‚¼ãƒ­ã‚¨ãƒŸãƒƒã‚·ãƒ§ãƒ³';
    const reportDate = document.getElementById('report-date').value;
    const storeName = document.getElementById('store-name').value;
    const reporterName = document.getElementById('reporter-name').value;
    const department = document.getElementById('department').value;
    const titleSub = document.getElementById('title-sub').value.trim();
    const title = titleSub ? `${titleSub} ${TYPE_TITLES[currentType]}` : TYPE_TITLES[currentType];
    const incidentDt = document.getElementById('incident-datetime').value.replace('T', ' ');
    const incidentPlace = document.getElementById('incident-place').value;
    const incidentDetail = document.getElementById('incident-detail').value;
    const cause = document.getElementById('cause').value;
    const countermeasure = document.getElementById('countermeasure').value;
    const notes = document.getElementById('notes').value;

    // ç¨®åˆ¥å›ºæœ‰ãƒ‡ãƒ¼ã‚¿
    let specificHTML = '';
    if (currentType === 'accident') {
      const injured = getRadio('injured');
      const police = getRadio('police');
      const ambulance = getRadio('ambulance');
      const injuredInfo = document.getElementById('injured-info').value;
      const damageRows = getDamageRows('accident');
      specificHTML = buildAccidentSpecific(injured, police, ambulance, injuredInfo, damageRows);
    } else if (currentType === 'incident') {
      const totalDamage = document.getElementById('total-damage').value;
      const policeNum = document.getElementById('police-number').value;
      const suspectInfo = document.getElementById('suspect-info').value;
      const damageRows = getDamageRows('incident');
      specificHTML = buildIncidentSpecific(totalDamage, policeNum, suspectInfo, damageRows);
    } else {
      const claimType = document.getElementById('claim-type').value;
      const handler = document.getElementById('handler-name').value;
      const custName = document.getElementById('customer-name').value;
      const custContact = document.getElementById('customer-contact').value;
      const claimResp = document.getElementById('claim-response').value;
      const claimResult = document.getElementById('claim-result').value;
      specificHTML = buildClaimSpecific(claimType, handler, custName, custContact, claimResp, claimResult);
    }

    // ===== æœ¬æ–‡HTMLï¼ˆå†™çœŸãªã—ï¼‰ =====
    const mainHTML = `
      <div style="font-family:'Meiryo','Yu Gothic','MS Gothic',sans-serif;color:#000;background:white;padding:30px 35px;width:730px;">
        <div style="font-size:14pt;font-weight:bold;margin-bottom:6px;">${company}</div>
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span style="font-size:11pt;">åº—èˆ—åï¼š<strong>${storeName}</strong>ã€€æ‰€å±ï¼š${department || 'â€•'}</span>
          <span style="font-size:11pt;">å ±å‘Šæ—¥ï¼š<strong>${reportDate}</strong></span>
        </div>
        <div style="display:flex;align-items:center;margin:10px 0 14px;border:2.5px solid #1a3a5c;padding:8px 16px;background:#f0f4f8;">
          <span style="font-size:12pt;font-weight:bold;margin-right:16px;color:#1a3a5c;">è¡¨é¡Œï¼š</span>
          <span style="font-size:18pt;font-weight:bold;color:#1a3a5c;">${title}</span>
          <span style="margin-left:auto;font-size:11pt;">å ±å‘Šè€…ï¼š<strong>${reporterName}</strong></span>
        </div>
        <div style="background:#1a3a5c;color:white;font-weight:bold;padding:5px 10px;margin-bottom:0;">ç™ºç”Ÿæƒ…å ±</div>
        <table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
          <tr>
            <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:90px;white-space:nowrap;">ç™ºç”Ÿæ—¥æ™‚</td>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${incidentDt}</td>
            <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:90px;white-space:nowrap;">ç™ºç”Ÿå ´æ‰€</td>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${incidentPlace}</td>
          </tr>
          <tr>
            <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;vertical-align:top;">ç™ºç”ŸçŠ¶æ³</td>
            <td colspan="3" style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;word-break:break-all;min-height:60px;">${incidentDetail}</td>
          </tr>
        </table>
        ${specificHTML}
        <div style="background:#1a3a5c;color:white;font-weight:bold;padding:5px 10px;margin-top:10px;margin-bottom:0;">åŸå› ãƒ»å¯¾ç­–</div>
        <table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
          <tr>
            <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:90px;white-space:nowrap;vertical-align:top;">ç™ºç”Ÿã®åŸå› </td>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;word-break:break-all;min-height:50px;">${cause || 'â€•'}</td>
          </tr>
          <tr>
            <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;vertical-align:top;white-space:nowrap;">å†ç™ºé˜²æ­¢ç­–</td>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;word-break:break-all;min-height:50px;">${countermeasure || 'â€•'}</td>
          </tr>
          <tr>
            <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;vertical-align:top;">å‚™è€ƒ</td>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;word-break:break-all;min-height:40px;">${notes || 'â€•'}</td>
          </tr>
        </table>
      </div>
    `;

    // ===== å†™çœŸHTMLï¼ˆåˆ†é›¢ï¼‰ =====
    const photosOnlyHTML = photos.length > 0 ? `
      <div style="font-family:'Meiryo','Yu Gothic','MS Gothic',sans-serif;color:#000;background:white;padding:20px 35px;width:730px;">
        <div style="background:#1a3a5c;color:white;font-weight:bold;padding:6px 12px;margin-bottom:12px;font-size:12pt;">ğŸ“· å†™çœŸæ·»ä»˜ï¼ˆ${photos.length}æšï¼‰</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;">
          ${photos.map((p,i) => `
            <div style="text-align:center;">
              <img src="${p.dataUrl}" style="width:100%;aspect-ratio:1;object-fit:cover;border:1.5px solid #333;display:block;">
              <div style="font-size:9pt;margin-top:3px;">å†™çœŸ ${i+1}</div>
            </div>
          `).join('')}
        </div>
      </div>
    ` : '';

    // ===== HTMLã‚’DOMã«æŒ¿å…¥ã—ã¦canvasã«å¤‰æ› =====
    const tmpl = document.getElementById('pdf-template');
    const h2cOpts = { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff', logging: false };

    // æœ¬æ–‡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    tmpl.innerHTML = mainHTML;
    tmpl.style.display = 'block';
    await new Promise(r => setTimeout(r, 200));
    const mainCanvas = await html2canvas(tmpl, h2cOpts);

    // å†™çœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    let photosCanvas = null;
    if (photos.length > 0) {
      tmpl.innerHTML = photosOnlyHTML;
      await new Promise(r => setTimeout(r, 200));
      photosCanvas = await html2canvas(tmpl, h2cOpts);
    }
    tmpl.style.display = 'none';

    // ===== PDFçµ„ã¿ç«‹ã¦ =====
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pdfW = pdf.internal.pageSize.getWidth();
    const pdfH = pdf.internal.pageSize.getHeight();
    const margin = 10;
    const contentW = pdfW - margin * 2;
    const xOff = (pdfW - contentW) / 2;

    // -- æœ¬æ–‡ã‚’ãƒšãƒ¼ã‚¸ã«é…ç½®ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰--
    const mainImgData = mainCanvas.toDataURL('image/jpeg', 0.95);
    const mainPdfH = contentW * (mainCanvas.height / mainCanvas.width);
    const pageContentH = pdfH - margin * 2;
    let currentY = margin; // ç¾åœ¨ã®Yåº§æ¨™ï¼ˆmmï¼‰

    if (mainPdfH <= pageContentH) {
      // 1ãƒšãƒ¼ã‚¸ã«åã¾ã‚‹
      pdf.addImage(mainImgData, 'JPEG', xOff, currentY, contentW, mainPdfH);
      currentY += mainPdfH;
    } else {
      // æœ¬æ–‡ãŒè¤‡æ•°ãƒšãƒ¼ã‚¸ã«ã¾ãŸãŒã‚‹å ´åˆ
      const pageHeightPx = mainCanvas.width * (pageContentH / contentW);
      let drawnPx = 0;
      while (drawnPx < mainCanvas.height) {
        if (drawnPx > 0) { pdf.addPage(); currentY = margin; }
        const sliceH = Math.min(pageHeightPx, mainCanvas.height - drawnPx);
        const sc = document.createElement('canvas');
        sc.width = mainCanvas.width; sc.height = sliceH;
        const ctx = sc.getContext('2d');
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,sc.width,sc.height);
        ctx.drawImage(mainCanvas, 0, -drawnPx);
        const slicePdfH = contentW * (sliceH / mainCanvas.width);
        pdf.addImage(sc.toDataURL('image/jpeg',0.95), 'JPEG', xOff, currentY, contentW, slicePdfH);
        currentY += slicePdfH;
        drawnPx += sliceH;
      }
    }

    // -- å†™çœŸã‚’é…ç½® --
    if (photosCanvas) {
      const photosPdfH = contentW * (photosCanvas.height / photosCanvas.width);
      const remainingH = pdfH - currentY - margin;

      if (remainingH < photosPdfH) {
        // æ®‹ã‚Šã‚¹ãƒšãƒ¼ã‚¹ã«åã¾ã‚‰ãªã„ â†’ æ–°ã—ã„ãƒšãƒ¼ã‚¸ã¸
        pdf.addPage();
        currentY = margin;
      }
      // å†™çœŸã‚’1ãƒšãƒ¼ã‚¸ã«åã‚ã‚‹ï¼ˆå†™çœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ãƒšãƒ¼ã‚¸å†…ã§å®Œçµï¼‰
      const photosImgData = photosCanvas.toDataURL('image/jpeg', 0.95);
      if (photosPdfH <= pageContentH) {
        pdf.addImage(photosImgData, 'JPEG', xOff, currentY, contentW, photosPdfH);
      } else {
        // å†™çœŸãŒéå¸¸ã«å¤šã„å ´åˆï¼ˆ11æšä»¥ä¸Šã¯æƒ³å®šå¤–ã ãŒå¿µã®ãŸã‚ï¼‰
        const photoPagePx = photosCanvas.width * (pageContentH / contentW);
        let pdrawnPx = 0;
        while (pdrawnPx < photosCanvas.height) {
          if (pdrawnPx > 0) { pdf.addPage(); currentY = margin; }
          const sliceH = Math.min(photoPagePx, photosCanvas.height - pdrawnPx);
          const sc = document.createElement('canvas');
          sc.width = photosCanvas.width; sc.height = sliceH;
          const ctx = sc.getContext('2d');
          ctx.fillStyle = '#fff'; ctx.fillRect(0,0,sc.width,sc.height);
          ctx.drawImage(photosCanvas, 0, -pdrawnPx);
          const slicePdfH = contentW * (sliceH / photosCanvas.width);
          pdf.addImage(sc.toDataURL('image/jpeg',0.95), 'JPEG', xOff, currentY, contentW, slicePdfH);
          currentY += slicePdfH;
          pdrawnPx += sliceH;
        }
      }
    }

    const filename = `${title}_${storeName}_${reportDate}.pdf`;

    // ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
    const ua = navigator.userAgent;
    const isIOS = /iP(hone|ad|od)/.test(ua) ||
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/.test(ua);

    if (isIOS) {
      // ===== iOSï¼šBlobã§æ–°ã—ã„ã‚¿ãƒ–ã«é–‹ã =====
      const pdfBlob = pdf.output('blob');
      const blobUrl = URL.createObjectURL(pdfBlob);
      const newTab = window.open(blobUrl, '_blank');
      if (!newTab) {
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        a.textContent = 'ğŸ“„ PDFã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‹ã';
        a.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:9999;display:block;padding:16px 32px;background:#1a3a5c;color:white;text-align:center;font-size:16px;font-weight:bold;border-radius:10px;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);white-space:nowrap;';
        document.body.appendChild(a);
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(blobUrl); }, 30000);
      } else {
        setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
      }

    } else if (isAndroid) {
      // ===== Androidï¼šDataURLã§aã‚¿ã‚°ã‚¯ãƒªãƒƒã‚¯ =====
      try {
        const pdfBlob = pdf.output('blob');
        const blobUrl = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(blobUrl); }, 3000);
      } catch(e2) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        const pdfBlob = pdf.output('blob');
        const blobUrl = URL.createObjectURL(pdfBlob);
        const newTab = window.open(blobUrl, '_blank');
        if (!newTab) {
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename;
          a.textContent = 'ğŸ“„ PDFã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä¿å­˜';
          a.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:9999;display:block;padding:16px 32px;background:#1a3a5c;color:white;text-align:center;font-size:16px;font-weight:bold;border-radius:10px;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);white-space:nowrap;';
          document.body.appendChild(a);
          setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(blobUrl); }, 30000);
        } else {
          setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
        }
      }

    } else {
      // ===== PCï¼šé€šå¸¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
      pdf.save(filename);
    }

  } catch(e) {
    console.error(e);
    alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n' + e.message);
  } finally {
    document.getElementById('loading').classList.remove('show');
  }
}

// ===== PDFç¨®åˆ¥å›ºæœ‰HTML =====
function buildAccidentSpecific(injured, police, ambulance, injuredInfo, damageRows) {
  return `
    <div style="background:#1a3a5c;color:white;font-weight:bold;padding:5px 10px;margin-top:10px;margin-bottom:0;">äººçš„ãƒ»ç‰©çš„è¢«å®³</div>
    <table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:100px;white-space:nowrap;">è² å‚·è€…ã®æœ‰ç„¡</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${injured}</td>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:100px;white-space:nowrap;">è­¦å¯Ÿã¸ã®å±Šå‡º</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${police}</td>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:80px;white-space:nowrap;">æ•‘æ€¥é€£çµ¡</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${ambulance}</td>
      </tr>
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;vertical-align:top;">è² å‚·è€…æƒ…å ±</td>
        <td colspan="5" style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;min-height:36px;">${injuredInfo || 'â€•'}</td>
      </tr>
    </table>
    ${buildDamageTable(damageRows)}
  `;
}

function buildIncidentSpecific(totalDamage, policeNum, suspectInfo, damageRows) {
  return `
    <div style="background:#1a3a5c;color:white;font-weight:bold;padding:5px 10px;margin-top:10px;margin-bottom:0;">äº‹ä»¶è©³ç´°</div>
    <table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:100px;white-space:nowrap;">è¢«å®³ç·é¡</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${totalDamage || 'â€•'}</td>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:110px;white-space:nowrap;">è­¦å¯Ÿå—ç†ç•ªå·</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${policeNum || 'â€•'}</td>
      </tr>
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;vertical-align:top;">å®¹ç–‘è€…ãƒ»é–¢ä¿‚è€…</td>
        <td colspan="3" style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;min-height:36px;">${suspectInfo || 'â€•'}</td>
      </tr>
    </table>
    ${buildDamageTable(damageRows)}
  `;
}

function buildClaimSpecific(claimType, handler, custName, custContact, claimResp, claimResult) {
  return `
    <div style="background:#1a3a5c;color:white;font-weight:bold;padding:5px 10px;margin-top:10px;margin-bottom:0;">ã‚¯ãƒ¬ãƒ¼ãƒ è©³ç´°</div>
    <table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:120px;white-space:nowrap;">ã‚¯ãƒ¬ãƒ¼ãƒ ã®ç¨®é¡</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${claimType}</td>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;width:100px;white-space:nowrap;">å¯¾å¿œæ‹…å½“è€…</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${handler || 'â€•'}</td>
      </tr>
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;white-space:nowrap;">é¡§å®¢æ°å</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${custName || 'â€•'}</td>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;white-space:nowrap;">é¡§å®¢é€£çµ¡å…ˆ</td>
        <td style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;">${custContact || 'â€•'}</td>
      </tr>
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;vertical-align:top;">å¯¾å¿œå†…å®¹</td>
        <td colspan="3" style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;min-height:40px;">${claimResp || 'â€•'}</td>
      </tr>
      <tr>
        <td style="background:#f0f0f0;font-weight:bold;border:1.5px solid #000;padding:6px 10px;vertical-align:top;">å¯¾å¿œçµæœ</td>
        <td colspan="3" style="background:#FFFF99;border:1.5px solid #000;padding:6px 10px;white-space:pre-wrap;min-height:36px;">${claimResult || 'â€•'}</td>
      </tr>
    </table>
  `;
}

function buildDamageTable(rows) {
  if (!rows || rows.length === 0) return '';
  return `
    <div style="background:#1a3a5c;color:white;font-weight:bold;padding:5px 10px;margin-top:0;margin-bottom:0;">è¢«å®³å“</div>
    <table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <thead>
        <tr>
          <th style="background:#d0d8e8;border:1.5px solid #000;padding:5px 8px;font-size:10pt;text-align:center;width:40%;">è¢«å®³å“å</th>
          <th style="background:#d0d8e8;border:1.5px solid #000;padding:5px 8px;font-size:10pt;text-align:center;width:30%;">ã‚·ãƒªã‚¢ãƒ«â„–</th>
          <th style="background:#d0d8e8;border:1.5px solid #000;padding:5px 8px;font-size:10pt;text-align:center;width:30%;">è¢«å®³é¡</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:5px 8px;">${r.name}</td>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:5px 8px;">${r.serial}</td>
            <td style="background:#FFFF99;border:1.5px solid #000;padding:5px 8px;">${r.amount}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}
</script>
</body>
</html>
